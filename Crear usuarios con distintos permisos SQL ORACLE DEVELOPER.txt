-- TIPS 
--CASO 1
MIOS
-------------------------------------------------------------------------------------

-- CREAR USUARIOS
--usuario 1
ALTER SESSION SET "_ORACLE_SCRIPT"= TRUE;
CREATE USER MDY2131_U1 IDENTIFIED BY "MDY2131_U1"
DEFAULT TABLESPACE "USERS"
TEMPORARY TABLESPACE "TEMP";
ALTER USER MDY2131_U1 QUOTA UNLIMITED ON USERS;
GRANT CREATE SESSION TO MDY2131_U1;
GRANT "RESOURCE" TO MDY2131_U1;
ALTER USER MDY2131_U1 DEFAULT ROLE "RESOURCE";

-- usuario 2

ALTER SESSION SET "_ORACLE_SCRIPT"=TRUE;
CREATE USER MDY2131_U2 IDENTIFIED BY "MDY2131_U2"
DEFAULT TABLESPACE "USERS"
TEMPORARY TABLESPACE "TEMP";
ALTER USER MDY2131_U2 QUOTA 100m ON USERS; -- ASIGNACION DE MB
GRANT CREATE SESSION TO MDY2131_U2;
GRANT "RESOURCE" TO MDY2131_U2;
ALTER USER MDY2131_U2 DEFAULT ROLE "RESOURCE";

-- DAR PERMISOS A LOS ROLES

--usuario 1
GRANT CREATE SESSION,
CREATE TABLE,
CREATE SEQUENCE,
CREATE ANY INDEX,
CREATE SYNONYM,
CREATE VIEW
TO MDY2131_P15_1; -- se asigna el rol creado a los permisos deseados


--usuario 2
GRANT CREATE SESSION,
GRANT CREATE PROCEDURE,
CREATE ANY INDEX,
CREATE VIEW
TO MDY2131_U2; -- se asigna el rol creado a los permisos deseados

GRANT CREATE SESSION,
GRANT CREATE PROCEDURE,
CREATE ANY INDEX,
TO MDY2131_U2;


--PERMISOS PARA CEAR SINONIMOS
GRANT CREATE SYNONYM, CREATE PUBLIC SYNONYM TO MDY2131_U1;


--CREAR SININIMOS
CREATE PUBLIC SYNONYM SYN_CITY FOR MDY2131_U1.CIUDAD;
GRANT SELECT ON MDY2131_U1.CIUDAD TO MDY2131_U2;

--CREAR ROL Y DAR PERMISOS.
CREATE ROLE ROL_CONSULTA;

 --  PERMISO PARA QUE ESTE USUARIO PUEDA CREAR INDICES
GRANT CREATE PROCEDURE, CREATE ANY INDEX TO ROL_CONSULTA;

--CASO 2

SELECT
    p.descripcion AS "PRODUCTO"
    ,pa.nompais AS "PAIS"
    ,um.descripcion AS "UNIDAD MEDIDA"
    ,count(db.codproducto) AS "CANTIDAD DE BOLETAS"
    ,'$'||trim(to_char(p.valorcomprapeso,'99g999g999')) AS "VALOR ACTUAL COMPRA"
    ,'$'||TRIM(TO_CHAR((p.valorcomprapeso*0.10)+valorcomprapeso,'99G999G999')) AS "NUEVO VALOR COMPRA" 
FROM
    producto p join pais pa
    ON p.codpais=pa.codpais
    join unidad_medida um
    on um.codunidad=p.codunidad
    join detalle_boleta db
    on p.codproducto=db.codproducto
    
    GROUP BY p.descripcion,pa.nompais,db.codproducto,p.valorcomprapeso,um.descripcion
    ORDER BY "CANTIDAD DE BOLETAS" DESC,p.descripcion ASC
    ;
-- CREAR VISTA.

CREATE VIEW IN_PROD_SUP_STOCK AS
SELECT
    p.descripcion AS "PRODUCTO"
    ,pa.nompais AS "PAIS"
    ,um.descripcion AS "UNIDAD MEDIDA"
    ,count(db.codproducto) AS "CANTIDAD DE BOLETAS"
    ,'$'||trim(to_char(p.valorcomprapeso,'99g999g999')) AS "VALOR ACTUAL COMPRA"
    ,'$'||TRIM(TO_CHAR((p.valorcomprapeso*0.10)+valorcomprapeso,'99G999G999')) AS "NUEVO VALOR COMPRA" 
FROM
    producto p join pais pa
    ON p.codpais=pa.codpais
    join unidad_medida um
    on um.codunidad=p.codunidad
    join detalle_boleta db
    on p.codproducto=db.codproducto
    
    WHERE p.totalstock >= 10
    GROUP BY p.descripcion,pa.nompais,db.codproducto,p.valorcomprapeso,um.descripcion
    ORDER BY "CANTIDAD DE BOLETAS" DESC,p.descripcion ASC
    ;

-- DAR PERMISOS A LA VISTA(USUARIO 2)
GRANT SELECT ON MDY2131_U1.IN_PROD_SUP_STOCK TO MDY2131_U2;

--VER VISTA DESDE EL USUARIO 2
SELECT * FROM MDY2131_U1.IN_PROD_SUP_STOCK;

--CASO 3

--CREAR INDICE DE ESTA CONSULTA
SELECT 
LPAD(c.rutcliente,12,' ') AS "RUT CLIENTE"
,c.nombre AS "NOMBRE CLIENTE"
,V.RUTVENDEDOR "RUT VENDEDOR"
,V.NOMBRE "NOMBRE VENDEDOR"
,TO_CHAR(total,'99g999g999') AS "MONTO"
FROM vendedor v join boleta b  ON(v.rutvendedor=b.rutvendedor)
join cliente c on (c.rutcliente=b.rutcliente)
where v.codcomuna = 8
order by v.nombre;


--INDICE
CREATE INDEX IDX_VENDEDOR_COMUNA ON VENDEDOR (codcomuna);

-- CONSULTA 2
SELECT b.numboleta
,INITCAP(nombre) AS "VENDEDOR"
,TO_CHAR(total,'99g999g999') AS TOTAL
FROM boleta b JOIN vendedor v ON (b.rutvendedor=v.rutvendedor)
where upper(substr(nombre,1,1)) = 'L'
order by 2;

--SUPUESTO INDICE (REVISAR)
CREATE INDEX IDX_VEN_NOM_INICIAL ON VENDEDOR (nombre);


--BORRAR INDICES
-- drop index NOMBREINDICE;

--DAR PERMISOS A LAS TABLAS SIN SINONIMOS

GRANT SELECT ON MDY2131_P15_1.APORTE_A_SBIF TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.CLIENTE TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.COMUNA TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.CREDITO TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.CREDITO_CLIENTE TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.CUOTA_CREDITO_CLIENTE TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.FORMA_PAGO TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.MOVIMIENTO TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.PRODUCTO_INVERSION TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.PRODUCTO_INVERSION_CLIENTE TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.PROFESION_OFICIO TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.PROVINCIA TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.REGION TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.SUCURSAL TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.TIPO_CONTRATO TO MDY2131_P15_2;
GRANT SELECT ON MDY2131_P15_1.TIPO_MOVIMIENTO TO MDY2131_P15_2;

----------------------------------------------------------------------------------------


----------------------------
--EJECUTAR CON SYSTEM
----------------------------


--CREACION DE USUARIOS
ALTER SESSION SET "_ORACLE_SCRIPT"= TRUE;

--CREACIÓN USUARIO DBADMIN

ALTER SESSION SET "_ORACLE_SCRIPT"= TRUE;
CREATE USER DBADMIN IDENTIFIED BY PWCONTRA
TEMPORARY TABLESPACE "TEMP";
ALTER USER DBADMIN QUOTA UNLIMITED ON USERS;

--CREACIÓN USUARIO ING_DATOS

ALTER SESSION SET "_ORACLE_SCRIPT"= TRUE;
CREATE USER ING_DATOS IDENTIFIED BY PWCONTRA
TEMPORARY TABLESPACE "TEMP";
ALTER USER ING_DATOS QUOTA UNLIMITED ON USERS;

--CREACIÓN USUARIO CLIENTE

ALTER SESSION SET "_ORACLE_SCRIPT"= TRUE;
CREATE USER USR_CLIENTE IDENTIFIED BY PWCONTRA
TEMPORARY TABLESPACE "TEMP";
ALTER USER USR_CLIENTE QUOTA UNLIMITED ON USERS;

--ASIGNACION DE PERMISOS

GRANT "CONNECT" TO DBADMIN, ING_DATOS, USR_CLIENTE;
--PERMISOS EXCLUSIVOS DE DBADMIN

GRANT "CONNECT" TO DBADMIN;
GRANT "RESOURCE" TO DBADMIN;
GRANT CREATE ANY INDEX TO DBADMIN;
GRANT CREATE SYNONYM TO DBADMIN;
GRANT CREATE PUBLIC SYNONYM TO DBADMIN;

--PERMISOS EXCLUSIVOS DEL INGENIERO DE DATOS

GRANT "CONNECT" TO INF_DATOS
GRANT CREATE ANY VIEW TO ING_DATOS;
GRANT CREATE MATERIALIZED VIEW  TO ING_DATOS;
GRANT CREATE SYNONYM TO ING_DATOS;
GRANT "RESOURCE" TO ING_DATOS;

--PERMISOS EXCLUSIVOS DEL USR_CLIENTE

GRANT "CONNECT" TO USR_CLIENTE
GRANT CREATE ANY VIEW TO USR_CLIENTE;
GRANT CREATE MATERIALIZED VIEW  TO USR_CLIENTE;



----------------------------
--EJECUTAR CON DBADMIN
----------------------------

--CREACIÓN DINÓNIMOS PÚBLICOS
CREATE PUBLIC SYNONYM syn_camion FOR camion;
CREATE PUBLIC SYNONYM syn_cliente FOR cliente;
--CREACIÓN SINÓNIMOS PRIVADOS
CREATE  SYNONYM syn_comuna FOR comuna;
CREATE  SYNONYM syn_estado_civil FOR estado_civil;

--OTORGAR PERMISOS AL INGENIERO DE DATOS

GRANT SELECT ON syn_camion TO ING_DATOS;
GRANT SELECT ON syn_cliente TO ING_DATOS;
GRANT SELECT ON DBADMIN.syn_comuna TO ING_DATOS;
GRANT SELECT ON DBADMIN.syn_estado_civil TO ING_DATOS;

--OTORGAR PERMISOS AL USUARIO CLIENTE
GRANT SELECT ON syn_camion TO USR_CLIENTE;
GRANT SELECT ON syn_cliente TO USR_CLIENTE;
GRANT SELECT ON DBADMIN.syn_comuna TO USR_CLIENTE;
GRANT SELECT ON DBADMIN.syn_estado_civil TO USR_CLIENTE;

--CREACIÓN DE ÍNDICES
CREATE INDEX idx_INICIAL_PNOMBRE_L on cliente (lower(substr(PNOMBRE_CLI,1,1)));
CREATE INDEX idx_dvrun on cliente (DVRUN_CLI);

SELECT PNOMBRE_CLI||' '|| SNOMBRE_CLI||' '|| APPATERNO_CLI ||' '||APMATERNO_CLI AS NOMBRE_COMPLETO
,PNOMBRE_CLI
,DVRUN_CLI
FROM CLIENTE
WHERE lower(substr(PNOMBRE_CLI,1,1))='m'
--and DVRUN_CLI='5'
ORDER BY 1;



----------------------------
--EJECUTAR CON ING_DATOS
----------------------------
--COMPROBAR PERMISOS DE ACCESOS SOBRE SINÓNIMOS PÚBLICO SY PROIVADOS

SELECT * FROM DBADMIN.syn_estado_civil;
SELECT * FROM syn_cliente;
SELECT * FROM DBADMIN.syn_comuna;
SELECT * FROM syn_camion;

----------

SELECT SYN_CLI.PNOMBRE_CLI NOMBRE_CLIENTE
,SYN_EC.NOMBRE_ESTADO_CIVIL ESTADO_CIVIL
,SYN_CLI.FECHA_NAC_CLI FECHA_NACIMINTO
,(EXTRACT (YEAR FROM SYSDATE))-( EXTRACT (YEAR FROM SYN_CLI.FECHA_NAC_CLI)) EDAD_CLIENTE
, CASE 
    WHEN (EXTRACT (YEAR FROM SYSDATE))-( EXTRACT (YEAR FROM SYN_CLI.FECHA_NAC_CLI))>40
    THEN 10000
    ELSE 0
    END BONO
FROM syn_cliente SYN_CLI JOIN DBADMIN.syn_estado_civil SYN_EC ON(SYN_CLI.ID_ESTADO_CIVIL = SYN_EC.ID_ESTADO_CIVIL)
ORDER BY SYN_CLI.FECHA_NAC_CLI DESC
;




SELECT PNOMBRE_CLI||' '|| SNOMBRE_CLI||' '|| APPATERNO_CLI ||' '||APMATERNO_CLI AS NOMBRE_COMPLETO
,PNOMBRE_CLI
,DVRUN_CLI
FROM syn_cliente
WHERE lower(substr(PNOMBRE_CLI,1,1))='m'
--and DVRUN_CLI='5'
ORDER BY 1;



----------------------------
--EJECUTAR CON USR_CLIENTE
----------------------------

CREATE  VIEW VISTA_BONOS_CLIENTES AS 
SELECT SYN_CLI.PNOMBRE_CLI NOMBRE_CLIENTE
,SYN_EC.NOMBRE_ESTADO_CIVIL ESTADO_CIVIL
,SYN_CLI.FECHA_NAC_CLI FECHA_NACIMINTO
,(EXTRACT (YEAR FROM SYSDATE))-( EXTRACT (YEAR FROM SYN_CLI.FECHA_NAC_CLI)) EDAD_CLIENTE
, CASE 
    WHEN (EXTRACT (YEAR FROM SYSDATE))-( EXTRACT (YEAR FROM SYN_CLI.FECHA_NAC_CLI))>40
    THEN 10000
    ELSE 0
    END BONO
FROM syn_cliente SYN_CLI JOIN DBADMIN.syn_estado_civil SYN_EC ON(SYN_CLI.ID_ESTADO_CIVIL = SYN_EC.ID_ESTADO_CIVIL)
ORDER BY SYN_CLI.FECHA_NAC_CLI DESC
WITH READ ONLY;